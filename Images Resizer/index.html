<html>
	<head>
		<!--Web App that permits to load a banch of local images and resize them-->
		<title>Image Resizer</title>
	</head>
	<body>
		<input type="file" fileread="files" onchange = "load()" id = "files" accept="image/*" autocomplete="off" multiple>
		<label for="width">Width [px]: </label><input type="number" name="width" id="width" autocomplete="off" value=""/>
		<label for="height">Height [px]: </label><input type="number" name="height" id="height" autocomplete="off" value=""/>
		<button onclick = "resize()" type="button" id="go">Resize</button>
		<div id="iterations">
		</div>
		<script>
			function load() {
				var fileInput = document.getElementById("files");
				var fileList = fileInput.files;

				var canvases = [];

				var iterations = document.getElementById("iterations");
				
				while (iterations.firstChild) {
				    iterations.removeChild(iterations.firstChild);
				}

				for (var i = 0; i<fileList.length; i++){
					var canvas = document.createElement("canvas");
					iterations.appendChild(canvas);
					canvases.push(canvas);
				}

				var c = 0;

				//use a self-invoking to draw images in canvases and wait to complete the drawing before passing to the next image.
				(function draw(){
					var img = new Image();
					var reader = new FileReader();
					var the_canvas = canvases[c];
					var context = the_canvas.getContext("2d");
					reader.onload = function(e){
						img.src = e.target.result;
					}
					img.onload = function(){
						the_canvas.width = img.width;
						the_canvas.height = img.height;
						
						context.drawImage(img,0,0,img.width,img.height);
						c++;
						if (c<canvases.length) draw();
					}
					reader.readAsDataURL(fileList[c]);	
				})();

			}

			function resize(){
				var button = document.getElementById("go");
				button.innerHTML = "Wait...";
				button.disabled = true;
				var canvases = document.getElementsByTagName("canvas");
				var width = document.getElementById("width").value;
				var height = document.getElementById("height").value;
				var p_height, p_width;
				var i = 0;
				(function scale(){
					var the_canvas = canvases[i];
					var img = new Image();
					img.onload = function(){
						console.log("entrato");
						p_height = Math.abs(the_canvas.height - height) / the_canvas.height;
						p_width = Math.abs(the_canvas.width - width) / the_canvas.width;
						console.log("calcolate le dimensioni");
						var aspect_ratio = the_canvas.width / the_canvas.height; //width on height
						
						if(p_height < p_width){
							the_canvas.height = height;
							the_canvas.width = aspect_ratio * height;
						}
						else{
							the_canvas.height = width / aspect_ratio; 
							the_canvas.width = width;
						}

						console.log("fatto il resize");
						
						img.height = the_canvas.height;
						img.width = the_canvas.width;
						//alert("ecchige");
						var ctx = the_canvas.getContext("2d");
						console.log("disegno l'immagine");
						ctx.drawImage(img,0,0,img.width,img.height);
						i++;
						if(i<canvases.length) scale();
						else{
							button.innerHTML = "Resize";
							button.disabled = false;
						}
					}
					img.src = the_canvas.toDataURL();
				})();
			}
		</script>
	</body>
</html>